<?xml version="1.0" encoding="utf-8" ?>
<local:MailListPageAbstract
    x:Class="OpenEmail.Views.MailListPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:Interactivity="using:Microsoft.Xaml.Interactivity"
    xmlns:behaviors="using:OpenEmail.Behaviors"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:controls1="using:OpenEmail.Controls"
    xmlns:converters="using:OpenEmail.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:data="using:OpenEmail.ViewModels.Data"
    xmlns:helpers="using:OpenEmail.Helpers"
    xmlns:local="using:OpenEmail.Views"
    xmlns:main="using:OpenEmail"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="using:CommunityToolkit.WinUI"
    x:Name="root"
    SizeChanged="PageSizeChanged"
    mc:Ignorable="d">

    <Page.Resources>
        <Style x:Key="MailActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{ThemeResource ApplicationPageBackgroundThemeBrush}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="BorderBrush" Value="{ThemeResource DetailForegroundBrush}" />
            <Setter Property="BorderThickness" Value="1.5" />
        </Style>

        <DataTemplate x:Key="MessageTemplate" x:DataType="data:MessageViewModel">
            <Grid
                MaxHeight="80"
                Padding="0,10"
                ColumnSpacing="6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="48" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!--  Avatar  -->
                <PersonPicture
                    Width="44"
                    DisplayName="{x:Bind ContactViewModel.ContactDisplayName, Mode=OneWay}"
                    ProfilePicture="{x:Bind ContactViewModel.ProfileThumbnailUrl, Converter={StaticResource ProfileImageConverter}, Mode=OneWay}" />

                <!--  Unrad badge  -->
                <Ellipse
                    Width="9"
                    Height="9"
                    Margin="0,4,0,0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Fill="{ThemeResource UnreadBadgeBrush}"
                    Visibility="{x:Bind helpers:XamlHelpers.ReverseBooleanToVisibility(IsRead), Mode=OneWay}" />


                <!--  Details  -->
                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Name & Date  -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBlock
                            FontWeight="{x:Bind helpers:XamlHelpers.IsReadConverter(Message.IsRead), Mode=OneWay}"
                            Text="{x:Bind ContactViewModel.ContactDisplayName}"
                            TextTrimming="CharacterEllipsis" />

                        <TextBlock
                            Grid.Column="1"
                            Margin="12,0,0,0"
                            VerticalAlignment="Center"
                            FontSize="12"
                            Foreground="{ThemeResource DetailForegroundBrush}"
                            Text="{x:Bind helpers:XamlHelpers.GetDisplayDateOnListingPage(Message.CreatedAt), Mode=OneWay}" />
                    </Grid>

                    <!--  Subject Read  -->
                    <TextBlock
                        Grid.Row="1"
                        FontWeight="{x:Bind helpers:XamlHelpers.IsReadConverter(Message.IsRead), Mode=OneWay}"
                        Text="{x:Bind helpers:XamlHelpers.EmptyTextConverter(Subject,'(no subject)'), Mode=OneWay}"
                        TextTrimming="CharacterEllipsis"
                        Visibility="{x:Bind IsRead, Mode=OneWay}" />

                    <!--  Subject Unread  -->
                    <TextBlock
                        Grid.Row="1"
                        FontWeight="{x:Bind helpers:XamlHelpers.IsReadConverter(Message.IsRead), Mode=OneWay}"
                        Foreground="{ThemeResource UnreadBadgeBrush}"
                        Text="{x:Bind helpers:XamlHelpers.EmptyTextConverter(Subject,'(no subject)'), Mode=OneWay}"
                        TextTrimming="CharacterEllipsis"
                        Visibility="{x:Bind helpers:XamlHelpers.ReverseBooleanToVisibility(IsRead), Mode=OneWay}" />

                    <!--  Message  -->
                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <controls1:FormattingRichTextblock
                            Grid.Row="2"
                            IsTextSelectionEnabled="False"
                            MaxLines="1"
                            Text="{x:Bind helpers:XamlHelpers.EmptyTextConverter(Body,'(no message)'), Mode=OneWay}"
                            TextTrimming="CharacterEllipsis"
                            TextWrapping="Wrap" />

                        <PathIcon
                            Grid.Column="1"
                            Data="F1 M 0 10 C 0 9.329428 0.063477 8.671875 0.19043 8.027344 C 0.317383 7.382812 0.511068 6.751303 0.771484 6.132812 C 0.888672 5.859375 1.025391 5.576172 1.181641 5.283203 C 1.337891 4.990234 1.508789 4.702148 1.694336 4.418945 C 1.879883 4.135742 2.076823 3.865561 2.285156 3.608398 C 2.49349 3.351238 2.711588 3.121746 2.939453 2.919922 C 3.004557 2.861328 3.066406 2.817383 3.125 2.788086 C 3.183594 2.758789 3.258463 2.744141 3.349609 2.744141 C 3.525391 2.744141 3.671875 2.809246 3.789062 2.939453 C 3.90625 3.069662 3.964844 3.219402 3.964844 3.388672 C 3.964844 3.49284 3.948568 3.579102 3.916016 3.647461 C 3.883463 3.71582 3.834635 3.785809 3.769531 3.857422 C 3.619792 4.026693 3.473307 4.189453 3.330078 4.345703 C 3.186849 4.501953 3.05013 4.671225 2.919922 4.853516 C 2.373047 5.602214 1.958008 6.414389 1.674805 7.290039 C 1.391602 8.16569 1.25 9.069011 1.25 10 C 1.25 10.598959 1.308594 11.189779 1.425781 11.772461 C 1.542969 12.355144 1.722005 12.923178 1.962891 13.476562 C 2.333984 14.342448 2.835286 15.123698 3.466797 15.820312 C 3.544922 15.911459 3.626302 15.996094 3.710938 16.074219 C 3.795573 16.152344 3.876953 16.23698 3.955078 16.328125 C 4.026692 16.40625 4.080403 16.481119 4.116211 16.552734 C 4.152018 16.62435 4.169922 16.715496 4.169922 16.826172 C 4.169922 17.001953 4.108073 17.148438 3.984375 17.265625 C 3.860677 17.382812 3.714193 17.441406 3.544922 17.441406 C 3.401693 17.441406 3.271484 17.392578 3.154297 17.294922 C 2.926432 17.112631 2.700195 16.888021 2.475586 16.621094 C 2.250977 16.354168 2.036133 16.072592 1.831055 15.776367 C 1.625976 15.480144 1.437174 15.179037 1.264648 14.873047 C 1.092122 14.567058 0.947266 14.2806 0.830078 14.013672 C 0.55013 13.375651 0.341797 12.721354 0.205078 12.050781 C 0.068359 11.380209 0 10.696615 0 10 Z M 16.455078 17.441406 C 16.285807 17.441406 16.139322 17.382812 16.015625 17.265625 C 15.891927 17.148438 15.830078 17.001953 15.830078 16.826172 C 15.830078 16.715496 15.847981 16.62435 15.883789 16.552734 C 15.919596 16.481119 15.973307 16.40625 16.044922 16.328125 C 16.123047 16.23698 16.204426 16.152344 16.289062 16.074219 C 16.373697 15.996094 16.455078 15.911459 16.533203 15.820312 C 17.164713 15.123698 17.666016 14.342448 18.037109 13.476562 C 18.277994 12.923178 18.457031 12.355144 18.574219 11.772461 C 18.691406 11.189779 18.75 10.598959 18.75 10 C 18.75 9.069011 18.608398 8.16569 18.325195 7.290039 C 18.041992 6.414389 17.626953 5.602214 17.080078 4.853516 C 16.949869 4.671225 16.81315 4.501953 16.669922 4.345703 C 16.526691 4.189453 16.380207 4.026693 16.230469 3.857422 C 16.165363 3.785809 16.116535 3.71582 16.083984 3.647461 C 16.051432 3.579102 16.035156 3.49284 16.035156 3.388672 C 16.035156 3.219402 16.09375 3.069662 16.210938 2.939453 C 16.328125 2.809246 16.474609 2.744141 16.650391 2.744141 C 16.741535 2.744141 16.816406 2.758789 16.875 2.788086 C 16.933594 2.817383 16.995441 2.861328 17.060547 2.919922 C 17.2819 3.115234 17.498371 3.341473 17.709961 3.598633 C 17.921549 3.855795 18.118488 4.125977 18.300781 4.40918 C 18.483072 4.692383 18.652344 4.982097 18.808594 5.27832 C 18.964844 5.574545 19.101562 5.859375 19.21875 6.132812 C 19.479166 6.744793 19.674479 7.374676 19.804688 8.022461 C 19.934895 8.670248 20 9.329428 20 10 C 20 11.39974 19.720051 12.737631 19.160156 14.013672 C 19.042969 14.2806 18.899738 14.567058 18.730469 14.873047 C 18.561197 15.179037 18.374023 15.480144 18.168945 15.776367 C 17.963867 16.072592 17.749023 16.354168 17.524414 16.621094 C 17.299805 16.888021 17.073566 17.112631 16.845703 17.294922 C 16.728516 17.392578 16.598307 17.441406 16.455078 17.441406 Z M 3.125 10 C 3.125 9.563803 3.170573 9.119467 3.261719 8.666992 C 3.352864 8.21452 3.4847 7.775066 3.657227 7.348633 C 3.829752 6.922201 4.042969 6.516928 4.296875 6.132812 C 4.550781 5.748699 4.840495 5.410157 5.166016 5.117188 C 5.224609 5.065104 5.283203 5.024414 5.341797 4.995117 C 5.400391 4.96582 5.472005 4.951172 5.556641 4.951172 C 5.725911 4.951172 5.870768 5.014648 5.991211 5.141602 C 6.111653 5.268555 6.171875 5.416667 6.171875 5.585938 C 6.171875 5.690104 6.153971 5.779623 6.118164 5.854492 C 6.082356 5.929363 6.0319 6.00586 5.966797 6.083984 C 5.712891 6.383464 5.486653 6.679688 5.288086 6.972656 C 5.089518 7.265625 4.921875 7.569987 4.785156 7.885742 C 4.648438 8.201498 4.545898 8.531901 4.477539 8.876953 C 4.40918 9.222006 4.375 9.596354 4.375 10 C 4.375 10.625 4.475911 11.232097 4.677734 11.821289 C 4.879557 12.410482 5.172526 12.949219 5.556641 13.4375 C 5.647786 13.554688 5.742188 13.665365 5.839844 13.769531 C 5.9375 13.873698 6.038411 13.98112 6.142578 14.091797 C 6.214192 14.169922 6.269531 14.249675 6.308594 14.331055 C 6.347656 14.412436 6.367188 14.508464 6.367188 14.619141 C 6.367188 14.788412 6.308594 14.934896 6.191406 15.058594 C 6.074219 15.182292 5.930989 15.244141 5.761719 15.244141 C 5.63151 15.244141 5.507812 15.195312 5.390625 15.097656 C 5.032552 14.798178 4.713542 14.44987 4.433594 14.052734 C 4.153646 13.6556 3.916015 13.23405 3.720703 12.788086 C 3.52539 12.342123 3.377278 11.881511 3.276367 11.40625 C 3.175456 10.93099 3.125 10.46224 3.125 10 Z M 14.238281 15.244141 C 14.06901 15.244141 13.925781 15.182292 13.808594 15.058594 C 13.691406 14.934896 13.632812 14.788412 13.632812 14.619141 C 13.632812 14.508464 13.652344 14.412436 13.691406 14.331055 C 13.730469 14.249675 13.785807 14.169922 13.857422 14.091797 C 13.961588 13.98112 14.0625 13.873698 14.160156 13.769531 C 14.257812 13.665365 14.352213 13.554688 14.443359 13.4375 C 14.827474 12.949219 15.120442 12.410482 15.322266 11.821289 C 15.524088 11.232097 15.625 10.625 15.625 10 C 15.625 9.596354 15.59082 9.222006 15.522461 8.876953 C 15.454102 8.531901 15.351562 8.201498 15.214844 7.885742 C 15.078125 7.569987 14.910481 7.265625 14.711914 6.972656 C 14.513346 6.679688 14.287108 6.383464 14.033203 6.083984 C 13.968099 6.00586 13.917643 5.929363 13.881836 5.854492 C 13.846027 5.779623 13.828124 5.690104 13.828125 5.585938 C 13.828124 5.416667 13.888346 5.268555 14.008789 5.141602 C 14.129231 5.014648 14.274088 4.951172 14.443359 4.951172 C 14.527994 4.951172 14.599609 4.96582 14.658203 4.995117 C 14.716797 5.024414 14.775391 5.065104 14.833984 5.117188 C 15.159504 5.410157 15.449218 5.748699 15.703125 6.132812 C 15.95703 6.516928 16.170246 6.922201 16.342773 7.348633 C 16.515299 7.775066 16.647135 8.21452 16.738281 8.666992 C 16.829426 9.119467 16.875 9.563803 16.875 10 C 16.875 10.46224 16.824543 10.93099 16.723633 11.40625 C 16.622721 11.881511 16.474609 12.342123 16.279297 12.788086 C 16.083984 13.23405 15.846354 13.6556 15.566406 14.052734 C 15.286457 14.44987 14.967447 14.798178 14.609375 15.097656 C 14.550781 15.14974 14.493814 15.187175 14.438477 15.209961 C 14.383137 15.232748 14.316405 15.244141 14.238281 15.244141 Z M 8.4375 10 C 8.4375 9.785156 8.479817 9.583334 8.564453 9.394531 C 8.649088 9.205729 8.761393 9.041342 8.901367 8.901367 C 9.041341 8.761394 9.205729 8.649089 9.394531 8.564453 C 9.583333 8.479818 9.785156 8.4375 10 8.4375 C 10.214844 8.4375 10.416666 8.479818 10.605469 8.564453 C 10.794271 8.649089 10.958658 8.761394 11.098633 8.901367 C 11.238606 9.041342 11.350911 9.205729 11.435547 9.394531 C 11.520182 9.583334 11.5625 9.785156 11.5625 10 C 11.5625 10.214844 11.520182 10.416667 11.435547 10.605469 C 11.350911 10.794271 11.238606 10.958659 11.098633 11.098633 C 10.958658 11.238607 10.794271 11.350912 10.605469 11.435547 C 10.416666 11.520183 10.214844 11.5625 10 11.5625 C 9.785156 11.5625 9.583333 11.520183 9.394531 11.435547 C 9.205729 11.350912 9.041341 11.238607 8.901367 11.098633 C 8.761393 10.958659 8.649088 10.794271 8.564453 10.605469 C 8.479817 10.416667 8.4375 10.214844 8.4375 10 Z "
                            Foreground="{ThemeResource BroadcastTagForegroundBrush}"
                            Visibility="{x:Bind IsBroadcast, Mode=OneWay}" />
                    </Grid>
                </Grid>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ReaderTemplate" x:DataType="data:ContactViewModel">
            <Button
                Margin="4,0"
                Padding="8,4"
                BorderBrush="{ThemeResource GeneralSeperatorBrush}"
                Command="{x:Bind RaiseDisplayContactCommand}"
                Content="{x:Bind ContactDisplayName, Mode=OneWay}"
                CornerRadius="2" />
        </DataTemplate>

        <converters:GridLengthConverter x:Key="GridLengthConverter" />
    </Page.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition
                Width="{x:Bind ViewModel.PreferencesService.MessageListingPaneWidth, Converter={StaticResource GridLengthConverter}}"
                MinWidth="250"
                MaxWidth="600" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>


        <!--  Left Content  -->
        <ListView
            Grid.Row="1"
            Padding="8,0"
            ItemTemplate="{StaticResource MessageTemplate}"
            ItemsSource="{x:Bind ViewModel.Messages}"
            SelectionMode="Extended">
            <ListView.Header>
                <Grid Padding="6,12" RowSpacing="6">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Title + Add  -->
                    <TextBlock
                        FontSize="20"
                        FontWeight="SemiBold"
                        Text="{x:Bind helpers:XamlHelpers.GetFolderHeaderTitle(ViewModel.CurrentMailFolderType), Mode=OneWay}" />

                    <AutoSuggestBox
                        Grid.Row="1"
                        BorderThickness="{ThemeResource AutoSuggestBoxBorderThicknes}"
                        PlaceholderText="Search"
                        QueryIcon="Find" />

                    <!--  No messages area  -->
                    <Grid
                        Grid.Row="2"
                        Padding="12"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="4"
                        Visibility="{x:Bind ViewModel.HasNoMessages, Mode=OneWay}">
                        <FontIcon
                            HorizontalAlignment="Left"
                            FontFamily="{StaticResource OpenEmailIconFontFamily}"
                            Glyph="{x:Bind helpers:XamlHelpers.GetFolderIconByFolderType(ViewModel.CurrentMailFolderType), Mode=OneWay}" />

                        <TextBlock
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            FontWeight="SemiBold">
                            <Run Text="{x:Bind ViewModel.CurrentMailFolderType, Mode=OneWay}" /><Run Text=" list is empty" />
                        </TextBlock>
                    </Grid>
                </Grid>
            </ListView.Header>
            <Interactivity:Interaction.Behaviors>
                <behaviors:ListViewMultiSelectBehavior SelectedItems="{x:Bind ViewModel.SelectedMessages, Mode=TwoWay}" />
            </Interactivity:Interaction.Behaviors>
        </ListView>


        <!--  Invisible grid splitter to adjust mail list.  -->
        <controls:GridSplitter
            Grid.Column="1"
            HorizontalAlignment="Center"
            Opacity="0" />

        <!--  Separation of list and content.  -->
        <Rectangle
            Grid.Column="1"
            Width="1"
            Fill="{ThemeResource NavigationViewItemSeparatorForeground}" />

        <!--  Right Content  -->

        <!--  Single selection.  -->
        <Grid
            Grid.Column="2"
            Padding="6,0,12,0"
            Visibility="{x:Bind ViewModel.HasSelectedSingleMessage, Mode=OneWay}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  New actions bar  -->
            <Grid
                Grid.Row="0"
                Margin="0,8"
                Padding="12,6"
                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                CornerRadius="{ThemeResource ControlCornerRadius}"
                RowSpacing="6"
                Visibility="{x:Bind ViewModel.HasSelectedSingleMessage, Mode=OneWay}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Subject  -->
                <TextBlock
                    FontSize="16"
                    FontWeight="SemiBold"
                    Text="{x:Bind ViewModel.SelectedSingleMessage.Subject, Mode=OneWay}"
                    TextWrapping="Wrap" />

                <!--  Others  -->
                <Grid
                    Grid.Row="1"
                    Margin="0,6,0,0"
                    RowSpacing="6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Sender / Reader  -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <PersonPicture
                            Width="48"
                            HorizontalAlignment="Left"
                            DisplayName="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.ContactDisplayName, Mode=OneWay}"
                            Initials="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.Initials, Mode=OneWay}"
                            ProfilePicture="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.ProfileThumbnailUrl, Mode=OneWay, Converter={StaticResource ProfileImageConverter}}" />
                        <Grid Grid.Column="1" Padding="12,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <HyperlinkButton
                                Margin="-4,0,0,0"
                                Padding="4,0"
                                VerticalAlignment="Top"
                                Command="{x:Bind ViewModel.DisplaySenderCommand}"
                                CommandParameter="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.Contact, Mode=OneWay}"
                                Foreground="{ThemeResource ApplicationForegroundThemeBrush}">
                                <TextBlock MaxLines="2" TextWrapping="Wrap">
                                    <Run FontWeight="SemiBold" Text="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.ContactDisplayName, Mode=OneWay}" />
                                    <Run
                                        FontSize="14"
                                        Foreground="{ThemeResource DetailForegroundBrush}"
                                        Text="{x:Bind ViewModel.SelectedSingleMessage.ContactViewModel.Contact.Address, Mode=OneWay}" />
                                </TextBlock>
                            </HyperlinkButton>

                            <!--  Readers  -->
                            <Grid Grid.Row="1" Visibility="{x:Bind helpers:XamlHelpers.ReverseBooleanToVisibility(ViewModel.SelectedSingleMessage.IsBroadcast), Mode=OneWay}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>

                                <FontIcon
                                    VerticalAlignment="Center"
                                    FontFamily="{ThemeResource OpenEmailIconFontFamily}"
                                    FontSize="14"
                                    Glyph="{x:Bind main:OpenEmailIcons.Contacts}" />

                                <ItemsRepeater
                                    Grid.Column="1"
                                    Margin="0,0,0,4"
                                    VerticalAlignment="Bottom"
                                    ItemsSource="{x:Bind ViewModel.SelectedSingleMessage.ReaderViewModels, Mode=OneWay}">
                                    <ItemsRepeater.Layout>
                                        <controls:WrapLayout Orientation="Horizontal" />
                                    </ItemsRepeater.Layout>
                                    <ItemsRepeater.ItemTemplate>
                                        <DataTemplate x:DataType="data:ContactViewModel">
                                            <HyperlinkButton
                                                Margin="2,0"
                                                Padding="4,0"
                                                Command="{x:Bind RaiseDisplayContactCommand}"
                                                Foreground="{ThemeResource DetailForegroundBrush}">
                                                <StackPanel Orientation="Horizontal" Spacing="4">
                                                    <TextBlock
                                                        MaxLines="2"
                                                        Text="{x:Bind ContactDisplayName}"
                                                        TextTrimming="CharacterEllipsis"
                                                        TextWrapping="Wrap" />
                                                    <FontIcon
                                                        Margin="0,2,0,0"
                                                        VerticalAlignment="Center"
                                                        FontFamily="{StaticResource OpenEmailIconFontFamily}"
                                                        FontSize="11"
                                                        Foreground="{ThemeResource ReaderDeliveredForegroundBrush}"
                                                        Glyph="{x:Bind main:OpenEmailIcons.Delivered}"
                                                        Visibility="{x:Bind IsOutboxDelivered}" />
                                                </StackPanel>
                                            </HyperlinkButton>
                                        </DataTemplate>
                                    </ItemsRepeater.ItemTemplate>
                                </ItemsRepeater>
                            </Grid>
                        </Grid>
                    </Grid>

                    <!--  Buttons / Date  -->
                    <Grid
                        Grid.Column="1"
                        HorizontalAlignment="Right"
                        RowSpacing="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!--  Buttons  -->
                        <StackPanel
                            HorizontalAlignment="Right"
                            Orientation="Horizontal"
                            Spacing="8">
                            <!--  Standard message buttons  -->
                            <StackPanel
                                Orientation="Horizontal"
                                Spacing="8"
                                Visibility="{x:Bind helpers:XamlHelpers.ReverseBooleanToVisibility(ViewModel.IsBroadcastMessage), Mode=OneWay}">
                                <controls1:CustomAppBarButton
                                    x:Name="ReplyButton"
                                    Command="{x:Bind ViewModel.ReplyCommand}"
                                    IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                    Label="Reply"
                                    Visibility="{x:Bind ViewModel.IsNotDraftMessage, Mode=OneWay}">
                                    <controls1:CustomAppBarButton.Icon>
                                        <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.Reply}" />
                                    </controls1:CustomAppBarButton.Icon>
                                </controls1:CustomAppBarButton>

                                <controls1:CustomAppBarButton
                                    x:Name="ReplyAllButton"
                                    Command="{x:Bind ViewModel.ReplyAllCommand}"
                                    IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                    Label="Reply All"
                                    Visibility="{x:Bind ViewModel.ShouldDisplayReplyAll, Mode=OneWay}">
                                    <controls1:CustomAppBarButton.Icon>
                                        <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.ReplyAll}" />
                                    </controls1:CustomAppBarButton.Icon>
                                </controls1:CustomAppBarButton>

                                <controls1:CustomAppBarButton
                                    x:Name="SendButton"
                                    IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                    Label="Send"
                                    Visibility="{x:Bind ViewModel.IsDraftMessage, Mode=OneWay}">
                                    <controls1:CustomAppBarButton.Icon>
                                        <Viewbox Width="16">
                                            <PathIcon Data="F1 M 20 9.375 C 20 9.498698 19.967447 9.611003 19.902344 9.711914 C 19.837238 9.812826 19.749348 9.889323 19.638672 9.941406 L 0.888672 18.691406 C 0.810547 18.730469 0.722656 18.75 0.625 18.75 C 0.442708 18.75 0.292969 18.689779 0.175781 18.569336 C 0.058594 18.448893 0 18.297525 0 18.115234 C 0 18.082682 0 18.053385 0 18.027344 C 0 18.001303 0.00651 17.97526 0.019531 17.949219 L 2.470703 9.375 L 0.019531 0.800781 C 0.00651 0.77474 0 0.748699 0 0.722656 C 0 0.696615 0 0.667318 0 0.634766 C 0 0.452475 0.058594 0.301107 0.175781 0.180664 C 0.292969 0.060223 0.442708 0 0.625 0 C 0.722656 0 0.810547 0.019531 0.888672 0.058594 L 19.638672 8.808594 C 19.879557 8.919271 20 9.108073 20 9.375 Z M 1.601562 16.982422 L 17.900391 9.375 L 1.601562 1.767578 L 3.603516 8.75 L 11.875 8.75 C 12.04427 8.75 12.190754 8.81185 12.314453 8.935547 C 12.43815 9.059245 12.5 9.205729 12.5 9.375 C 12.5 9.544271 12.43815 9.690756 12.314453 9.814453 C 12.190754 9.938151 12.04427 10 11.875 10 L 3.603516 10 Z " />
                                        </Viewbox>
                                    </controls1:CustomAppBarButton.Icon>
                                </controls1:CustomAppBarButton>

                                <controls1:CustomAppBarButton
                                    x:Name="ForwardButton"
                                    Command="{x:Bind ViewModel.ForwardCommand}"
                                    IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                    Label="Forward"
                                    Visibility="{x:Bind ViewModel.IsNotDraftMessage, Mode=OneWay}">
                                    <controls1:CustomAppBarButton.Icon>
                                        <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.Forward}" />
                                    </controls1:CustomAppBarButton.Icon>
                                </controls1:CustomAppBarButton>

                                <controls1:CustomAppBarButton
                                    x:Name="EditDraftButton"
                                    Command="{x:Bind ViewModel.EditDraftMessageCommand}"
                                    IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                    Label="Edit"
                                    Visibility="{x:Bind ViewModel.IsDraftMessage, Mode=OneWay}">
                                    <controls1:CustomAppBarButton.Icon>
                                        <Viewbox Width="16">
                                            <PathIcon Data="F1 M 19.931641 3.212891 C 19.931641 3.681641 19.84375 4.135743 19.667969 4.575195 C 19.492188 5.014649 19.238281 5.400392 18.90625 5.732422 L 6.425781 18.212891 C 6.347656 18.291016 6.258138 18.356119 6.157227 18.408203 C 6.056314 18.460287 5.950521 18.502604 5.839844 18.535156 L 1.005859 19.746094 C 0.940755 19.759115 0.891927 19.765625 0.859375 19.765625 C 0.690104 19.765625 0.54362 19.705404 0.419922 19.584961 C 0.296224 19.464518 0.234375 19.319662 0.234375 19.150391 C 0.234375 19.111328 0.240885 19.059244 0.253906 18.994141 L 1.464844 14.160156 C 1.497396 14.049479 1.539714 13.943686 1.591797 13.842773 C 1.64388 13.741862 1.708984 13.652344 1.787109 13.574219 L 14.404297 0.957031 C 14.710286 0.651043 15.066731 0.415039 15.473633 0.249023 C 15.880533 0.083008 16.298828 0 16.728516 0 C 17.177734 0 17.597656 0.083008 17.988281 0.249023 C 18.378906 0.415039 18.719074 0.642904 19.008789 0.932617 C 19.298502 1.222332 19.524738 1.5625 19.6875 1.953125 C 19.85026 2.34375 19.931641 2.763672 19.931641 3.212891 Z M 18.681641 3.251953 C 18.681641 2.972006 18.634439 2.709961 18.540039 2.46582 C 18.445637 2.22168 18.312174 2.008465 18.139648 1.826172 C 17.967121 1.643881 17.760416 1.502279 17.519531 1.401367 C 17.278645 1.300457 17.014973 1.25 16.728516 1.25 C 16.481119 1.25 16.26302 1.28418 16.074219 1.352539 C 15.885416 1.420898 15.711262 1.513672 15.551758 1.630859 C 15.392252 1.748047 15.240885 1.881512 15.097656 2.03125 C 14.954426 2.18099 14.801432 2.33724 14.638672 2.5 L 17.5 5.361328 C 17.66276 5.205078 17.815754 5.052084 17.958984 4.902344 C 18.102213 4.752605 18.227539 4.596355 18.334961 4.433594 C 18.442383 4.270834 18.527018 4.095053 18.588867 3.90625 C 18.650715 3.717449 18.681641 3.49935 18.681641 3.251953 Z M 1.71875 18.28125 L 5.537109 17.324219 L 16.621094 6.240234 L 13.759766 3.378906 L 2.675781 14.462891 Z " />
                                        </Viewbox>
                                    </controls1:CustomAppBarButton.Icon>
                                </controls1:CustomAppBarButton>
                            </StackPanel>


                            <controls1:CustomAppBarButton
                                x:Name="DeleteButton"
                                Command="{x:Bind ViewModel.DeleteCommand}"
                                IsCompact="{x:Bind IsCompactPage, Mode=OneWay}"
                                Label="Delete">
                                <controls1:CustomAppBarButton.KeyboardAccelerators>
                                    <KeyboardAccelerator Key="Delete" />
                                </controls1:CustomAppBarButton.KeyboardAccelerators>
                                <controls1:CustomAppBarButton.Icon>
                                    <FontIcon
                                        FontFamily="{StaticResource OpenEmailIconFontFamily}"
                                        FontSize="14"
                                        Glyph="{x:Bind main:OpenEmailIcons.Trash}" />
                                </controls1:CustomAppBarButton.Icon>
                            </controls1:CustomAppBarButton>
                        </StackPanel>

                        <!--  Receive Date  -->
                        <TextBlock
                            Grid.Row="1"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Top"
                            FontSize="13"
                            Foreground="{ThemeResource DetailForegroundBrush}"
                            Text="{x:Bind helpers:XamlHelpers.GetFormattedLocalTimeDate(ViewModel.SelectedSingleMessage.CreatedAt,'g'), Mode=OneWay}" />
                    </Grid>

                    <!--  Attachments  -->
                    <ListView
                        Grid.Row="1"
                        Margin="-12,6"
                        ui:ListViewExtensions.Command="{x:Bind ViewModel.OpenAttachmentCommand, Mode=OneWay}"
                        IsItemClickEnabled="True"
                        ItemTemplate="{StaticResource AttachmentTemplate}"
                        ItemsSource="{x:Bind ViewModel.SelectedSingleMessage.AttachmentViewModels, Mode=OneWay}"
                        SelectionMode="None">

                        <ListView.Resources>
                            <Style BasedOn="{StaticResource DefaultListViewItemStyle}" TargetType="ListViewItem">
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="CornerRadius" Value="4" />
                                <Setter Property="Margin" Value="10,0" />
                            </Style>
                        </ListView.Resources>
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsWrapGrid MaximumRowsOrColumns="1" />
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                    </ListView>
                </Grid>
            </Grid>

            <!--  Message content  -->
            <Grid
                Grid.Row="1"
                Padding="12"
                VerticalAlignment="Top"
                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}"
                CornerRadius="{ThemeResource ControlCornerRadius}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <controls1:FormattingRichTextblock Text="{x:Bind ViewModel.SelectedSingleMessage.Body, Mode=OneWay}" />
                    <!--<TextBlock
                        IsTextSelectionEnabled="True"
                        Text="{x:Bind ViewModel.SelectedSingleMessage.Body, Mode=OneWay}"
                        TextWrapping="Wrap" />-->
                </ScrollViewer>
            </Grid>
        </Grid>

        <!--  No message selected  -->
        <StackPanel
            Grid.Column="2"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Opacity="0.6"
            Spacing="4"
            Visibility="{x:Bind ViewModel.HasNoSelectedMessage, Mode=OneWay}">
            <Viewbox Width="28">
                <PathIcon
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Data="F1 M 16.943359 2.5 C 17.353516 2.5 17.744141 2.583008 18.115234 2.749023 C 18.486328 2.915039 18.810221 3.136395 19.086914 3.413086 C 19.363605 3.689779 19.584961 4.013673 19.750977 4.384766 C 19.916992 4.75586 20 5.146485 20 5.556641 L 20 15.693359 C 20 16.103516 19.916992 16.494141 19.750977 16.865234 C 19.584961 17.236328 19.363605 17.560221 19.086914 17.836914 C 18.810221 18.113607 18.486328 18.334961 18.115234 18.500977 C 17.744141 18.666992 17.353516 18.75 16.943359 18.75 L 3.056641 18.75 C 2.646484 18.75 2.255859 18.666992 1.884766 18.500977 C 1.513672 18.334961 1.189779 18.113607 0.913086 17.836914 C 0.636393 17.560221 0.415039 17.236328 0.249023 16.865234 C 0.083008 16.494141 0 16.103516 0 15.693359 L 0 5.556641 C 0 5.146485 0.083008 4.75586 0.249023 4.384766 C 0.415039 4.013673 0.636393 3.689779 0.913086 3.413086 C 1.189779 3.136395 1.513672 2.915039 1.884766 2.749023 C 2.255859 2.583008 2.646484 2.5 3.056641 2.5 Z M 3.125 3.75 C 2.871094 3.75 2.630208 3.798828 2.402344 3.896484 C 2.174479 3.994141 1.974284 4.129232 1.801758 4.301758 C 1.629232 4.474285 1.494141 4.67448 1.396484 4.902344 C 1.298828 5.130209 1.25 5.371094 1.25 5.625 L 1.25 5.898438 L 10 11.142578 L 18.75 5.898438 L 18.75 5.625 C 18.75 5.371094 18.701172 5.130209 18.603516 4.902344 C 18.505859 4.67448 18.370768 4.474285 18.198242 4.301758 C 18.025715 4.129232 17.82552 3.994141 17.597656 3.896484 C 17.369791 3.798828 17.128906 3.75 16.875 3.75 Z M 16.875 17.5 C 17.128906 17.5 17.369791 17.451172 17.597656 17.353516 C 17.82552 17.255859 18.025715 17.120768 18.198242 16.948242 C 18.370768 16.775717 18.505859 16.575521 18.603516 16.347656 C 18.701172 16.119791 18.75 15.878906 18.75 15.625 L 18.75 7.353516 L 10.322266 12.412109 C 10.224609 12.470703 10.117188 12.5 10 12.5 C 9.882812 12.5 9.775391 12.470703 9.677734 12.412109 L 1.25 7.353516 L 1.25 15.625 C 1.25 15.878906 1.298828 16.119791 1.396484 16.347656 C 1.494141 16.575521 1.629232 16.775717 1.801758 16.948242 C 1.974284 17.120768 2.174479 17.255859 2.402344 17.353516 C 2.630208 17.451172 2.871094 17.5 3.125 17.5 Z "
                    Foreground="Gray" />
            </Viewbox>
            <TextBlock
                FontSize="17"
                FontWeight="Normal"
                Foreground="Gray"
                HorizontalTextAlignment="Center"
                Style="{StaticResource SubtitleTextBlockStyle}"
                Text="No message selected"
                TextWrapping="WrapWholeWords" />
        </StackPanel>

        <!--  Multi selection.  -->
        <Grid Grid.Column="2" Visibility="{x:Bind ViewModel.HasMultipleMessagesSelected, Mode=OneWay}">
            <StackPanel
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Spacing="6">
                <TextBlock
                    FontSize="20"
                    HorizontalTextAlignment="Center"
                    Style="{StaticResource SubheaderTextBlockStyle}"
                    TextWrapping="Wrap">
                    <Run Text="{x:Bind ViewModel.SelectedMessages.Count, Mode=OneWay}" /><Run Text=" messages selected" />
                </TextBlock>

                <!--  Regular context menu  -->
                <Grid Visibility="{x:Bind helpers:XamlHelpers.VisibilityOrReverseConverter(ViewModel.IsTrashFolder, ViewModel.IsOutboxFolder), Mode=OneWay}">
                    <Button HorizontalAlignment="Stretch" Command="{x:Bind ViewModel.DeleteCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.Trash}" />
                            <TextBlock
                                VerticalAlignment="Center"
                                FontWeight="SemiBold"
                                Text="Move to Trash" />
                        </StackPanel>
                    </Button>
                </Grid>

                <!--  Trash context menu  -->
                <Grid Visibility="{x:Bind ViewModel.IsTrashFolder, Mode=OneWay}">
                    <Button HorizontalAlignment="Stretch" Command="{x:Bind ViewModel.DeletePermanentlyCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.Trash}" />
                            <TextBlock
                                VerticalAlignment="Center"
                                FontWeight="SemiBold"
                                Text="Delete Permanently" />
                        </StackPanel>
                    </Button>
                </Grid>

                <!--  Outbox context menu  -->
                <Grid Visibility="{x:Bind ViewModel.IsOutboxFolder, Mode=OneWay}">
                    <Button HorizontalAlignment="Stretch" Command="{x:Bind ViewModel.RecallAndDeleteCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon FontFamily="{StaticResource OpenEmailIconFontFamily}" Glyph="{x:Bind main:OpenEmailIcons.Trash}" />
                            <TextBlock
                                VerticalAlignment="Center"
                                FontWeight="SemiBold"
                                Text="Recall and Delete" />
                        </StackPanel>
                    </Button>
                </Grid>
            </StackPanel>
        </Grid>
    </Grid>
</local:MailListPageAbstract>

